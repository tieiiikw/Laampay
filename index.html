<!DOCTYPE html>  
<html lang="en">  
<head>  
  <meta charset="UTF-8">  
  <title>LaamPay ‚Äî ETB Wallet</title>  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>  
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>  
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>    
  <style>  
    * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }  
      
    body {  
      margin: 0;  
      background: linear-gradient(135deg, #007bff, #00d4ff);  
      color: #fff;  
      display: flex;  
      justify-content: center;  
      align-items: flex-start;  
      min-height: 100vh;  
      padding: 20px;  
    }  

    .container {  
      background: rgba(255, 255, 255, 0.15);  
      backdrop-filter: blur(15px);  
      border-radius: 20px;  
      padding: 25px;  
      width: 100%;  
      max-width: 400px;  
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);  
      animation: fadeIn 0.6s ease;  
      position: relative;  
    }  

    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .verification-badge {
      font-size: 14px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
      margin-left: auto;
    }

    .verified {
      background: rgba(0, 255, 179, 0.2);
      color: #00ffb3;
      border: 1px solid #00ffb3;
    }

    .unverified {
      background: rgba(255, 165, 0, 0.2);
      color: #ffa500;
      border: 1px solid #ffa500;
    }

    h2 { text-align: center; font-size: 1.8em; margin-bottom: 10px; }  
    h3 { text-align: center; font-size: 1.2em; margin-top: 15px; }  
   
    .balance-card {  
      text-align: center;  
      margin-bottom: 15px;  
      padding: 15px;  
      background: rgba(255,255,255,0.2);  
      border-radius: 10px;  
    }  

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .action-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .action-btn.active {
      background: #00ffb3;
      color: #003344;
    }

    .action-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.3);
    }

    .form-section {
      background: rgba(255,255,255,0.15);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      animation: slideDown 0.3s ease;
      display: none;
    }

    .form-section.show {
      display: block;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    input, button, select, textarea {  
      width: 100%;  
      padding: 12px;  
      margin: 8px 0;  
      border: none;  
      border-radius: 10px;  
      font-size: 15px;  
      outline: none;  
    }  

    input, select, textarea {  
      background: rgba(255, 255, 255, 0.25);  
      color: #fff;  
    }  

    input::placeholder, textarea::placeholder { color: #eee; }  

    button {  
      background: #00ffb3;  
      color: #003344;  
      font-weight: bold;  
      cursor: pointer;  
      transition: all 0.3s;  
    }  

    button:hover { background: #00ffaa; }  

    .hidden { display: none; }  

    .tx-item {  
      background: rgba(255,255,255,0.1);  
      padding: 12px;  
      border-radius: 10px;  
      margin: 8px 0;  
      font-size: 14px;  
      border-left: 4px solid #00ffb3;  
    }  

    .status-message {
      text-align: center;
      margin-top: 8px;
      padding: 8px;
      border-radius: 5px;
      font-size: 14px;
    }

    .status-success {
      background: rgba(0, 255, 179, 0.2);
      color: #00ffb3;
    }

    .status-error {
      background: rgba(255, 82, 82, 0.2);
      color: #ff5252;
    }

    /* P2P Styles */
    .offer-item {
      background: rgba(255,255,255,0.1);
      padding: 12px;
      border-radius: 10px;
      margin: 8px 0;
      border-left: 4px solid #00ffb3;
    }
    
    .offer-item.sell {
      border-left-color: #ff5252;
    }
    
    .offer-item.buy {
      border-left-color: #00ffb3;
    }
    
    .offer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .offer-type {
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .type-buy {
      background: rgba(0, 255, 179, 0.2);
      color: #00ffb3;
    }
    
    .type-sell {
      background: rgba(255, 82, 82, 0.2);
      color: #ff5252;
    }
    
    .offer-details {
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .offer-rate {
      font-weight: bold;
      color: #00ffb3;
    }
    
    .exchange-rate {
      background: rgba(255,255,255,0.1);
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
    }

    .features {  
      margin-top: 30px;  
      display: grid;  
      grid-template-columns: repeat(2, 1fr);  
      gap: 15px;  
    }  

    .feature {  
      background: rgba(255, 255, 255, 0.1);  
      padding: 15px;  
      border-radius: 10px;  
      text-align: center;  
    }  

    .bottom-buttons{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:15px;
    }

    .danger{
      background:#ff5252;
      color:#fff;
      font-weight:bold;
      border:none;
      border-radius:8px;
      padding:10px;
      cursor:pointer;
      width:100%;
      margin-top: 15px;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @media (max-width: 480px) {  
      .container {  
        padding: 20px;  
      }  

      .features {  
        grid-template-columns: 1fr;  
      }  
    }  
  </style>  
</head>  
<body>  
  <!-- AUTH SECTION -->
  <div class="container" id="authSection">
    <div class="logo">
      <h1>üí∏ LaamPay</h1>
      <p>Your Secure ETB Wallet</p>
    </div>
    
    <div class="auth-buttons">
      <button class="auth-btn active" id="registerBtn">Register</button>
      <button class="auth-btn" id="loginBtn">Login</button>
    </div>
    
    <div class="form-container">
      <!-- REGISTER FORM -->
      <div class="form" id="registerForm">
        <div class="input-group">
          <label for="regUsername">Username</label>
          <input type="text" id="regUsername" placeholder="Enter your username">
        </div>
        
        <div class="input-group">
          <label for="regEmail">Email</label>
          <input type="email" id="regEmail" placeholder="Enter your email">
        </div>
        
        <div class="input-group">
          <label for="regPhone">Phone Number</label>
          <input type="tel" id="regPhone" placeholder="Enter your phone number">
        </div>
        
        <div class="input-group">
          <label for="regPassword">Password</label>
          <input type="password" id="regPassword" placeholder="Create a password">
        </div>
        
        <button class="submit-btn" id="btnRegister">Create Account</button>
      </div>
      
      <!-- LOGIN FORM -->
      <div class="form hidden" id="loginForm">
        <div class="input-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" placeholder="Enter your email">
        </div>
        
        <div class="input-group">
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" placeholder="Enter your password">
        </div>
        
        <button class="submit-btn" id="btnLogin">Sign In</button>
      </div>
    </div>
    
    <div class="features">
      <div class="feature">
        <i class="fas fa-shield-alt"></i>
        <h3>Secure</h3>
        <p>Bank-level security</p>
      </div>
      <div class="feature">
        <i class="fas fa-bolt"></i>
        <h3>Fast</h3>
        <p>Instant transactions</p>
      </div>
      <div class="feature">
        <i class="fas fa-globe"></i>
        <h3>Global</h3>
        <p>Send money anywhere</p>
      </div>
      <div class="feature">
        <i class="fas fa-headset"></i>
        <h3>Support</h3>
        <p>24/7 customer service</p>
      </div>
    </div>
  </div> 
 
<!-- WALLET SECTION -->
  <div class="container hidden" id="walletSection">
    <div class="user-info">
      <h3>Welcome, <span id="userName">User</span></h3>
      <span id="verificationStatus" class="verification-badge unverified">
        <i class="fas fa-times-circle"></i> Unverified
      </span>
    </div>
    <div class="balance-card">
      <p>Current Balance</p>
      <h2><span id="userBalance">0.00</span> ETB</h2>
      <button id="btnRefresh">üîÑ Refresh</button>
    </div>
    
    <div class="action-buttons">
      <button id="sendBtnMain" class="action-btn">üì§ Send</button>
      <button id="requestBtnMain" class="action-btn">üì• Request</button>
      <button id="p2pBtnMain" class="action-btn">üí± P2P Trade</button>
    </div>

    <!-- SEND FORM -->
    <div id="sendForm" class="form-section">
      <label>Send to (Username/Email/Phone)</label>
      <input type="text" id="sendTo" placeholder="Enter recipient details">
      <label>Amount (ETB)</label>
      <input type="number" id="sendAmount" placeholder="Enter amount">
      <label>Note (Optional)</label>
      <textarea id="sendNote" rows="2" placeholder="Add a note"></textarea>
      <button id="btnSend">Send Money</button>
      <div id="sendStatus" class="status-message"></div>
    </div>

    <!-- REQUEST FORM -->
    <div id="requestForm" class="form-section">
      <label>Request from (Username/Email/Phone)</label>
      <input type="text" id="requestFrom" placeholder="Enter user details">
      <label>Amount (ETB)</label>
      <input type="number" id="requestAmount" placeholder="Enter amount">
      <label>Note (Optional)</label>
      <textarea id="requestNote" rows="2" placeholder="Add a note"></textarea>
      <button id="btnRequest">Send Request</button>
      <div id="requestStatus" class="status-message"></div>
    </div>

    <!-- P2P EXCHANGE FORM -->
    <div id="p2pForm" class="form-section">
      <div class="action-buttons">
        <button id="buyBtn" class="action-btn active">Buy USD</button>
        <button id="sellBtn" class="action-btn">Sell USD</button>
      </div>
      
      <div class="exchange-rate">
        <p style="text-align: center; margin: 10px 0; font-size: 14px;">
          üí± Live Rate: <strong>1 USD = <span id="currentRate">57.50</span> ETB</strong>
          <button id="btnUpdateRate" style="background: none; border: none; color: #00ffb3; cursor: pointer; font-size: 12px; margin-left: 5px;">üîÑ Update</button>
        </p>
        <p style="text-align: center; margin: 5px 0; font-size: 12px; opacity: 0.8;">
          Source: <strong>XE.com</strong> | Last updated: <span id="rateTimestamp">-</span>
        </p>
      </div>
      
      <div class="form-group">
        <label id="amountLabel">Amount in USD</label>
        <input type="number" id="exchangeAmount" placeholder="Enter amount">
      </div>
      
      <div class="form-group">
        <label>You will <span id="receiveText">pay</span>:</label>
        <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; text-align: center;">
          <strong><span id="calculatedAmount">0.00</span> <span id="currencyType">ETB</span></strong>
        </div>
      </div>
      
      <div class="form-group">
        <label>Payment Method</label>
        <select id="paymentMethod">
          <option value="bank_transfer">Bank Transfer</option>
          <option value="tele_birr">TeleBirr</option>
          <option value="m_pesa">M-Pesa</option>
          <option value="cash">Cash</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Your Offer Details</label>
        <textarea id="offerDetails" rows="2" placeholder="Add payment details or special instructions"></textarea>
      </div>
      
      <button id="btnPostOffer" class="action-btn">üìù Post Offer</button>
      <div id="exchangeStatus" class="status-message"></div>
    </div>

    <div class="bottom-buttons">
      <button id="btnTxHistory" class="action-btn">üìú History</button>
      <button id="btnSettings" class="action-btn">‚öôÔ∏è Settings</button>
    </div>
    
<!-- SETTINGS MODAL -->    <div id="settingsModal" class="modal hidden">  
    <div class="modal-content">  
      <div class="modal-header">  
        <h5>Settings</h5>  
        <button class="close-modal" id="closeSettings">√ó</button>  
      
  <div class="form-group">  
        <h4>Profile Information</h4>
        <div class="user-info">  
  <span>Verification Status:</span>  
  <span id="profileVerificationStatus" class="verification-badge unverified">  
    <i class="fas fa-times-circle"></i> Unverified  
  </span>  
</div>
    <input id="profileUsername" placeholder="Username">  
    <input id="profileEmail" placeholder="Email" disabled>  
    <input id="profilePhone" placeholder="Phone Number">  
    <button id="btnUpdateProfile">Update Profile</button>  
    <div id="profileStatus" class="status-message"></div>  
  </div>  

  <hr style="border-color: rgba(255,255,255,0.2); margin:15px 0;">  

<!-- KYC Verification -->
<div class="form-group">  
  <h5>KYC Verification</h5>  
  <p style="font-size: 14px; margin-bottom: 15px;">Complete your KYC to unlock all features</p>  
  
  <select id="kycDocumentType">  
    <option value="">Select Document Type</option>  
    <option value="national_id">National ID</option>  
    <option value="passport">Passport</option>  
    <option value="driving_license">Driving License</option>  
  </select>  
  
  <input id="kycDocumentNumber" placeholder="Document Number">  
  <input id="kycFullName" placeholder="Full Name (as on document)">  
  <input id="kycDateOfBirth" type="date" placeholder="Date of Birth">  
  <textarea id="kycAddress" placeholder="Address" rows="3"></textarea>  
  
  <!-- Document Upload -->
  <div class="file-upload">
    <label for="kycDocumentFile" class="file-upload-label">
      üì∑ Upload Document Image (Front)
   </label>
    <input type="file" id="kycDocumentFile" accept="image/*">
    <div id="kycFileName" class="file-name"></div>
  </div>
  </div>
  </div>
 
  
  <button id="btnSubmitKYC">Submit KYC</button>  
  <div id="kycStatus" class="status-message"></div>  
</div>
  </div>
 

    <div id="txList" class="hidden" style="margin-top:15px;"></div>
    <button id="btnLogout" class="danger">Logout</button>
  </div>
  </div>
  </div>
  <script>  
    // --- Firebase Config ---  
    const firebaseConfig = {  
      apiKey: "AIzaSyC1Vwy0v0DT0xJvJL2frTw-ol8sfZQX3hI",  
      authDomain: "laampay-71a0e.firebaseapp.com",  
      projectId: "laampay-71a0e",  
      storageBucket: "laampay-71a0e.firebasestorage.app",  
      messagingSenderId: "280848370047",  
      appId: "1:280848370047:web:0b0066863b7bd0d564324a",  
      measurementId: "G-B833BYL4L6"  
    };  

    firebase.initializeApp(firebaseConfig);  
    const auth = firebase.auth();  
    const db = firebase.firestore();  

    const authSection = document.getElementById('authSection');  
    const walletSection = document.getElementById('walletSection');  
    const userName = document.getElementById('userName');  
    const userBalance = document.getElementById('userBalance');  
    const txList = document.getElementById('txList');  
    const sendStatus = document.getElementById('sendStatus');  
    let currentUser = null;  

    // P2P Exchange functionality
    let currentExchangeRate = 57.50;
    let isBuying = true;
    let rateLastUpdated = null;

    // Function to fetch live exchange rate
    async function fetchLiveExchangeRate() {
      try {
        // Using a simple API for exchange rates (free tier)
        const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
        const data = await response.json();
        return data.rates.ETB || 57.50;
      } catch (error) {
        console.error('Error fetching live rate:', error);
        return 57.50; // Fallback rate
      }
    }

    // Update exchange rate display
    async function updateExchangeRate() {
      try {
        document.getElementById('currentRate').textContent = 'Loading...';
        document.getElementById('rateTimestamp').textContent = 'Updating...';
        
        const newRate = await fetchLiveExchangeRate();
        currentExchangeRate = newRate;
        
        document.getElementById('currentRate').textContent = newRate.toFixed(2);
        rateLastUpdated = new Date();
        document.getElementById('rateTimestamp').textContent = rateLastUpdated.toLocaleTimeString();
        
        calculateExchangeAmount();
        
        showExchangeStatus('‚úÖ Rate updated successfully!', 'success');
      } catch (error) {
        console.error('Failed to update rate:', error);
        document.getElementById('currentRate').textContent = currentExchangeRate.toFixed(2);
        showExchangeStatus('‚ùå Failed to update rate. Using cached rate.', 'error');
      }
    }

    // Update exchange UI
    function updateExchangeUI() {
      if (isBuying) {
        document.getElementById('amountLabel').textContent = 'Amount in USD';
        document.getElementById('receiveText').textContent = 'pay';
        document.getElementById('currencyType').textContent = 'ETB';
      } else {
        document.getElementById('amountLabel').textContent = 'Amount in ETB';
        document.getElementById('receiveText').textContent = 'receive';
        document.getElementById('currencyType').textContent = 'USD';
      }
      calculateExchangeAmount();
    }

    // Calculate exchange amount
    function calculateExchangeAmount() {
      const amount = parseFloat(document.getElementById('exchangeAmount').value) || 0;
      let calculatedAmount;
      
      if (isBuying) {
        calculatedAmount = amount * currentExchangeRate;
      } else {
        calculatedAmount = amount / currentExchangeRate;
      }
      
      document.getElementById('calculatedAmount').textContent = calculatedAmount.toFixed(2);
    }

    // Show exchange status
    function showExchangeStatus(message, type) {
      const statusEl = document.getElementById('exchangeStatus');
      statusEl.textContent = message;
      statusEl.className = `status-message status-${type}`;
      setTimeout(() => {
        statusEl.textContent = '';
        statusEl.className = 'status-message';
      }, 3000);
    }

    // Auth Forms Toggle
    document.getElementById('registerBtn').addEventListener('click', () => {
      document.getElementById('registerBtn').classList.add('active');
      document.getElementById('loginBtn').classList.remove('active');
      document.getElementById('registerForm').classList.remove('hidden');
      document.getElementById('loginForm').classList.add('hidden');
    });

    document.getElementById('loginBtn').addEventListener('click', () => {
      document.getElementById('loginBtn').classList.add('active');
      document.getElementById('registerBtn').classList.remove('active');
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('registerForm').classList.add('hidden');
    });

    // Form Toggle Functionality - FIXED
    function setupFormToggles() {
      const sendBtn = document.getElementById('sendBtnMain');
      const requestBtn = document.getElementById('requestBtnMain');
      const p2pBtn = document.getElementById('p2pBtnMain');
      const sendForm = document.getElementById('sendForm');
      const requestForm = document.getElementById('requestForm');
      const p2pForm = document.getElementById('p2pForm');

      function hideAllForms() {
        sendForm.classList.remove('show');
        requestForm.classList.remove('show');
        p2pForm.classList.remove('show');
        sendBtn.classList.remove('active');
        requestBtn.classList.remove('active');
        p2pBtn.classList.remove('active');
      }

      sendBtn.addEventListener('click', () => {
        hideAllForms();
        sendForm.classList.add('show');
        sendBtn.classList.add('active');
      });

      requestBtn.addEventListener('click', () => {
        hideAllForms();
        requestForm.classList.add('show');
        requestBtn.classList.add('active');
      });

      p2pBtn.addEventListener('click', () => {
        hideAllForms();
        p2pForm.classList.add('show');
        p2pBtn.classList.add('active');
        
        // Load exchange rate when P2P form is opened
        if (!rateLastUpdated) {
          updateExchangeRate();
        }
      });
    }

    // Buy/Sell toggle - FIXED
    function setupBuySellToggle() {
      const buyBtn = document.getElementById('buyBtn');
      const sellBtn = document.getElementById('sellBtn');

      buyBtn.addEventListener('click', () => {
        isBuying = true;
        buyBtn.classList.add('active');
        sellBtn.classList.remove('active');
        updateExchangeUI();
      });

      sellBtn.addEventListener('click', () => {
        isBuying = false;
        sellBtn.classList.add('active');
        buyBtn.classList.remove('active');
        updateExchangeUI();
      });
    }

    // Event listeners for exchange calculations
    document.getElementById('exchangeAmount').addEventListener('input', calculateExchangeAmount);

    // Update rate button
    document.getElementById('btnUpdateRate').addEventListener('click', updateExchangeRate);

 // Post P2P Offer - FIXED
    document.getElementById('btnPostOffer').addEventListener('click', async () => {
      const amount = parseFloat(document.getElementById('exchangeAmount').value);
      const paymentMethod = document.getElementById('paymentMethod').value;
      const offerDetails = document.getElementById('offerDetails').value.trim();
      
      if (!amount || amount <= 0) {
        showExchangeStatus('‚ùå Please enter a valid amount', 'error');
        return;
      }
      
      if (!currentUser) {
        showExchangeStatus('‚ùå Please log in first', 'error');
        return;
      }
      
      try {
        const offerData = {
          type: isBuying ? 'buy' : 'sell',
          amount: amount,
          rate: currentExchangeRate,
          calculatedAmount: isBuying ? amount * currentExchangeRate : amount / currentExchangeRate,
          paymentMethod: paymentMethod,
          offerDetails: offerDetails,
          userId: currentUser.uid,
          userName: userName.innerText,
          status: 'active',
          timestamp: Date.now(),
          rateTimestamp: rateLastUpdated
        };
        
        await db.collection('p2pOffers').add(offerData);
        
        showExchangeStatus('‚úÖ Offer posted successfully!', 'success');
        document.getElementById('exchangeAmount').value = '';
        document.getElementById('offerDetails').value = '';
        
      } catch (error) {
        showExchangeStatus('‚ùå Failed to post offer: ' + error.message, 'error');
      }
    });

    // Initialize all functionality when page loads
    document.addEventListener('DOMContentLoaded', function() {
      setupFormToggles();
      setupBuySellToggle();
      updateExchangeUI(); // Initialize UI
    });

    // Your existing functions
    // Register
    document.getElementById('btnRegister').onclick = async () => {
      const username = document.getElementById('regUsername').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const phone = document.getElementById('regPhone').value.trim();
      const password = document.getElementById('regPassword').value.trim();

      if (!username || !email || !password) return alert("Please fill all fields");
      try {
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        const uid = cred.user.uid;
        await db.collection("users").doc(uid).set({
          username, email, phone, balance: 10, createdAt: Date.now()
        });
        alert("Account created! Default balance: 1000 ETB");
      } catch (err) {
        alert(err.message);
      }
    };

    // Login
    document.getElementById('btnLogin').onclick = async () => {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (err) {
        alert(err.message);
      }
    };

    // Auth state
    auth.onAuthStateChanged(async user => {
      if (user) {
        currentUser = user;
        authSection.classList.add("hidden");
        walletSection.classList.remove("hidden");
        loadWallet();
      } else {
        walletSection.classList.add("hidden");
        authSection.classList.remove("hidden");
      }
    });
 
// Update loadWallet function to include verification status
async function loadWallet() {  
  const doc = await db.collection("users").doc(currentUser.uid).get();  
  if (!doc.exists) return alert("No wallet found!");  
  const data = doc.data();  
  userName.innerText = data.username || data.email;  
  userBalance.innerText = (data.balance || 0).toFixed(2);  
  updateVerificationStatus(data.kycStatus || 'unverified');
}

      
// Load profile data for settings
    async function loadProfileData() {
      const doc = await db.collection("users").doc(currentUser.uid).get();
      if (doc.exists) {
        const data = doc.data();
        document.getElementById('profileUsername').value = data.username || '';
        document.getElementById('profileEmail').value = data.email || '';
        document.getElementById('profilePhone').value = data.phone || '';
      }
    }

    document.getElementById('btnRefresh').onclick = loadWallet;  

    // Send Money
    document.getElementById('btnSend').onclick = async () => {
      const to = document.getElementById('sendTo').value.trim();
      const amount = parseFloat(document.getElementById('sendAmount').value.trim());
      const note = document.getElementById('sendNote').value.trim();
      
      if (!to || isNaN(amount) || amount <= 0) {
        sendStatus.innerText = "‚ùå Please enter valid amount and recipient";
        sendStatus.className = "status-message status-error";
        return;
      }

      if (!currentUser) {
        sendStatus.innerText = "‚ùå Please log in first";
        sendStatus.className = "status-message status-error";
        return;
      }

      const senderRef = db.collection("users").doc(currentUser.uid);
      const senderDoc = await senderRef.get();
      const senderData = senderDoc.data();

      let recipientDoc;
      for (let field of ["username","email","phone"]) {
        const snap = await db.collection("users").where(field,"==",to).get();
        if (!snap.empty) { recipientDoc = snap.docs[0]; break; }
      }
      
      if (!recipientDoc) {
        sendStatus.innerText = "‚ùå Recipient not found";
        sendStatus.className = "status-message status-error";
        return;
      }
      
      const recipientId = recipientDoc.id;
      const recipientData = recipientDoc.data();
      
      if (recipientId === currentUser.uid) {
        sendStatus.innerText = "‚ùå Cannot send to yourself";
        sendStatus.className = "status-message status-error";
        return;
      }
      
      if ((senderData.balance || 0) < amount) {
        sendStatus.innerText = "‚ùå Insufficient funds";
        sendStatus.className = "status-message status-error";
        return;
      }

      try {
        await db.runTransaction(async (tx) => {
          const senderSnap = await tx.get(senderRef);
          const recSnap = await tx.get(db.collection("users").doc(recipientId));
          const newSenderBal = (senderSnap.data().balance || 0) - amount;
          const newRecBal = (recSnap.data().balance || 0) + amount;
          tx.update(senderRef, { balance: newSenderBal });
          tx.update(db.collection("users").doc(recipientId), { balance: newRecBal });
          
          const txData = {
            fromUserId: currentUser.uid,
            fromUsername: senderData.username,
            toUserId: recipientId,
            toUsername: recipientData.username,
            amount,
            note,
            timestamp: Date.now(),
            type: 'transfer'
          };
          const txRef = db.collection("transactions").doc();
          tx.set(txRef, txData);
          
          return txData;
        }).then((txData) => {
          sendStatus.innerText = "‚úÖ Transaction successful!";
          sendStatus.className = "status-message status-success";
          document.getElementById('sendAmount').value = "";
          document.getElementById('sendTo').value = "";
          document.getElementById('sendNote').value = "";
          loadWallet();
        });
        
      } catch (e) {
        sendStatus.innerText = "‚ùå Failed: " + e.message;
        sendStatus.className = "status-message status-error";
      }
    };

    // Logout  
    document.getElementById('btnLogout').onclick = () => auth.signOut();

    // Initialize exchange rate on first load
    updateExchangeRate();
// Settings Modal
    document.getElementById('btnSettings').onclick = () => {
      document.getElementById('settingsModal').classList.remove('hidden');
    };

    document.getElementById('closeSettings').onclick = () => {
      document.getElementById('settingsModal').classList.add('hidden');
    };

    // Update Profile
    document.getElementById('btnUpdateProfile').onclick = async () => {
      const username = document.getElementById('profileUsername').value.trim();
      const phone = document.getElementById('profilePhone').value.trim();
      
      if (!username) {
        profileStatus.innerText = "‚ùå Username is required";
        profileStatus.className = "status-message status-error";
        return;
      }
      
      try {
        await db.collection("users").doc(currentUser.uid).update({
          username,
          phone
        });
        
        profileStatus.innerText = "‚úÖ Profile updated successfully!";
        profileStatus.className = "status-message status-success";
        loadWallet(); // Refresh to show updated username
      } catch (e) {
        profileStatus.innerText = "‚ùå Failed: " + e.message;
        profileStatus.className = "status-message status-error";
      }
    };
// KYC Document Upload
document.getElementById('kycDocumentFile').addEventListener('change', function(e) {
  const fileName = e.target.files[0] ? e.target.files[0].name : 'No file chosen';
  document.getElementById('kycFileName').textContent = fileName;
});

// Submit KYC
document.getElementById('btnSubmitKYC').onclick = async () => {
  const documentType = document.getElementById('kycDocumentType').value;
  const documentNumber = document.getElementById('kycDocumentNumber').value.trim();
  const fullName = document.getElementById('kycFullName').value.trim();
  const dateOfBirth = document.getElementById('kycDateOfBirth').value;
  const address = document.getElementById('kycAddress').value.trim();
  const documentFile = document.getElementById('kycDocumentFile').files[0];
  
  if (!documentType || !documentNumber || !fullName || !dateOfBirth || !address || !documentFile) {
    kycStatus.innerText = "‚ùå Please fill all KYC fields and upload document image";
    kycStatus.className = "status-message status-error";
    return;
  }
  
  try {
    kycStatus.innerText = "‚è≥ Uploading KYC...";
    kycStatus.className = "status-message status-success";
    
    // Convert image to base64
    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const kycImage = e.target.result;
        
        await db.collection("users").doc(currentUser.uid).update({
          kyc: {
            documentType,
            documentNumber,
            fullName,
            dateOfBirth,
            address,
            kycImage: kycImage, // Store base64 image
            submittedAt: Date.now(),
            status: 'pending'
          },
          kycStatus: 'pending', // For easy querying
          kycAt: Date.now()
        });
        
        kycStatus.innerText = "‚úÖ KYC submitted successfully! Under review";
        kycStatus.className = "status-message status-success";
        
        // Refresh verification status
        updateVerificationStatus('pending');
        
      } catch (e) {
        kycStatus.innerText = "‚ùå Failed: " + e.message;
        kycStatus.className = "status-message status-error";
      }
    };
    reader.readAsDataURL(documentFile);
    
  } catch (e) {
    kycStatus.innerText = "‚ùå Failed: " + e.message;
    kycStatus.className = "status-message status-error";
  }
};

// Update verification status display
function updateVerificationStatus(status) {
  const verificationStatusEl = document.getElementById('verificationStatus');
  const profileVerificationStatusEl = document.getElementById('profileVerificationStatus');
  
  if (status === 'verified') {
    verificationStatusEl.innerHTML = '<i class="fas fa-check-circle"></i> Verified';
    verificationStatusEl.className = 'verification-badge verified';
    profileVerificationStatusEl.innerHTML = '<i class="fas fa-check-circle"></i> Verified';
    profileVerificationStatusEl.className = 'verification-badge verified';
  } else if (status === 'pending') {
    verificationStatusEl.innerHTML = '<i class="fas fa-clock"></i> Under Review';
    verificationStatusEl.className = 'verification-badge pending';
    profileVerificationStatusEl.innerHTML = '<i class="fas fa-clock"></i> Under Review';
    profileVerificationStatusEl.className = 'verification-badge pending';
  } else {
    verificationStatusEl.innerHTML = '<i class="fas fa-times-circle"></i> Unverified';
    verificationStatusEl.className = 'verification-badge unverified';
    profileVerificationStatusEl.innerHTML = '<i class="fas fa-times-circle"></i> Unverified';
    profileVerificationStatusEl.className = 'verification-badge unverified';
  }
}

// Load verification status
async function loadVerificationStatus() {
  const doc = await db.collection("users").doc(currentUser.uid).get();
  if (doc.exists) {
    const data = doc.data();
    updateVerificationStatus(data.kycStatus || 'unverified');
  }
}

document.addEventListener("DOMContentLoaded", function() {
  const btnTxHistory = document.getElementById("btnTxHistory");
  const txList = document.getElementById("txList");

  btnTxHistory.addEventListener("click", async () => {
    // Toggle display
    txList.classList.toggle("hidden");

    if (!txList.classList.contains("hidden")) {
      txList.innerHTML = "<p>Loading transaction history...</p>";

      try {
        const user = firebase.auth().currentUser;
        if (!user) throw new Error("User not logged in");

        const userId = user.uid;

        const snapshot = await firebase.firestore()
          .collection("transactions")
          .where("userId", "==", userId)
          .orderBy("date", "desc")
          .get();

        if (snapshot.empty) {
          txList.innerHTML = "<p>No transactions found.</p>";
        } else {
          let html = "";
          snapshot.forEach(doc => {
            const tx = doc.data();
            html += `
              <div class="tx-item">
                <p><strong>${tx.type}</strong>: ${tx.amount} ETB</p>
                <p>To/From: ${tx.counterparty}</p>
                <p>Date: ${tx.date.toDate().toLocaleString()}</p>
                <hr>
              </div>
            `;
          });
          txList.innerHTML = html;
        }

      } catch (err) {
        console.error(err);
        txList.innerHTML = "<p>Error loading transactions.</p>";
      }
    }
  });
});
    

    
const statusEl = document.getElementById("profileVerificationStatus");

  if (isVerified) {
    statusEl.classList.remove("unverified");
    statusEl.classList.add("verified");
    statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Verified';
  } else {
    statusEl.classList.remove("verified");
    statusEl.classList.add("unverified");
    statusEl.innerHTML = '<i class="fas fa-times-circle"></i> Unverified';
  }
     
// Load profile data for settings
    async function loadProfileData() {
      const doc = await db.collection("users").doc(currentUser.uid).get();
      if (doc.exists) {
        const data = doc.data();
        document.getElementById('profileUsername').value = data.username || '';
        document.getElementById('profileEmail').value = data.email || '';
        document.getElementById('profilePhone').value = data.phone || '';
      }
    }

    document.getElementById('btnRefresh').onclick = loadWallet;  
function showReceipt(data) {
  // Haddii hore modal jiro, ka saar
  const oldModal = document.getElementById("receiptModal");
  if (oldModal) oldModal.remove();

  // Modal container
  const modal = document.createElement("div");
  modal.id = "receiptModal";
  Object.assign(modal.style, {
    position: "fixed",
    top: "0",
    left: "0",
    width: "100vw",
    height: "100vh",
    background: "rgba(0,0,0,0.6)",
    display: "flex",
    justifyContent: "center",
    alignItems: "center",
    zIndex: "9999",
    padding: "10px",
    boxSizing: "border-box",
  });

  // Receipt box
  const content = document.createElement("div");
  Object.assign(content.style, {
    background: "#003344",
    color: "#fff",
    padding: "20px",
    borderRadius: "12px",
    width: "340px",
    maxWidth: "95%",
    boxShadow: "0 0 10px rgba(0,0,0,0.3)",
    textAlign: "left",
    fontFamily: "monospace",
    opacity: "0",           // fade-in
    transform: "scale(0.95)", // slight scale effect
    transition: "all 0.25s ease-in-out",
  });

  content.innerHTML = `
    <h2 style="text-align:center; color:#00ffb3;">‚úÖ Success!</h2>
    <h4 style="text-align:center;">Transfer Successful</h4>
    <hr style="opacity:0.2; margin:10px 0;">
    <h3 style="text-align:center; color:#00ffb3;">ETB ${data.amount}</h3>
    <div style="margin-top:15px; line-height:1.6;">
      <p><strong>From:</strong>      ${data.fromUsername || "-"}</p>
      <p><strong>To:</strong>        ${data.toUsername || "-"}</p>
      <p><strong>Date:</strong>      ${new Date().toLocaleString()}</p>
      <p><strong>Transfer ID:</strong> TX-${Math.floor(Math.random()*1000000)}</p>
      <p><strong>Description:</strong> ${data.note || "No note"}</p>
    </div>
    <button id="closeReceiptBtn" style="
      width:100%; 
      margin-top:15px; 
      background:#00ffb3; 
      color:#003344; 
      padding:10px; 
      border:none; 
      border-radius:8px; 
      font-weight:bold;
    ">Close</button>
  `;

  modal.appendChild(content);
  document.body.appendChild(modal);

  // Small timeout for fade-in
  setTimeout(() => {
    content.style.opacity = "1";
    content.style.transform = "scale(1)";
  }, 10);

  // Close button
  document.getElementById("closeReceiptBtn").addEventListener("click", () => {
    modal.remove();
  });
}

// ‚úÖ Example
function onTransactionSuccess() {
  showReceipt({
    fromUsername: "Ahmed",
    toUsername: "Mohamed",
    amount: "15",
    note: "Ok"
  });
}
  </script>
</body>  
</html>
